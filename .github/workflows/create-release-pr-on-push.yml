name: Create Release PR on Push

on:
  push:
    branches:
      - "release/*/*"

jobs:
  check_pr_labels:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.check_pr_labels.outputs.result }}
    name: A job to check the PR labels contain given labels
    steps:
      - name: Check PR labels action step
        id: check_pr_labels
        uses: shioyang/check-pr-labels-on-push-action@v1.0.9
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          labels: '["by-ubuntu"]'
        timeout-minutes: 2
      - name: See result
        run: echo "${{ steps.check_pr_labels.outputs.result }}"

  create_pr:
    permissions: write-all
    needs: check_pr_labels
    env:
      RUN_LABEL_EXIST: ${{ needs.check_pr_labels.outputs.result }}
    runs-on: if $RUN_LABEL_EXIST='false' ; then ubuntu-latest; else self-hosted; fi
    steps:
      - name: check env
        run: echo $RUN_LABEL_EXIST

      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set Environment Variables
        run: |
          BRANCH_NAME=$(echo $GITHUB_REF | sed -e "s/refs\/heads\///")
          PACKAGE_NAME=$(echo $BRANCH_NAME | cut -d/ -f2)
          RELEASE_VERSION=$(echo $BRANCH_NAME | cut -d/ -f3)
          PR_TITLE=":package:release/$PACKAGE_NAME/$RELEASE_VERSION staging 배포"
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
          if [ ${{ github.actor }} = "leekh716" ]; then
            echo REVIEWER="rhiokim" >> $GITHUB_ENV
          else
            echo REVIEWER="leekh716" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        uses: devops-infra/action-pull-request@v0.5.5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_branch: "main"
          title: ${{ env.PR_TITLE }}
          assignee: ${{ github.actor }}
          reviewer: ${{ env.REVIEWER }}
          new_string: ${{ github.event.commits[0].message }}
          get_diff: false
