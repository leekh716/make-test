name: Create Release PR on Push

on:
  push:
    branches:
      - "release/*/*"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.set_runner.outputs.runner }}
    name: A job to check the PR labels contain given labels
    steps:
      - name: Check PR labels action step
        id: check_pr_labels
        uses: shioyang/check-pr-labels-on-push-action@v1.0.9
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          labels: '["by-ubuntu"]'
        timeout-minutes: 1
      - name: set runner
        id: set_runner
        run: |
          if [ ${{ steps.check_pr_labels.outputs.result }}=true ]; then
            echo "runner=ubuntu-latest" >> $GITHUB_OUTPUT
          else
            echo "runner=self-hosted" >> $GITHUB_OUTPUT
          fi

  create_pr:
    permissions: write-all
    needs: [setup]
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set Environment Variables
        run: |
          BRANCH_NAME=$(echo $GITHUB_REF | sed -e "s/refs\/heads\///")
          PACKAGE_NAME=$(echo $BRANCH_NAME | cut -d/ -f2)
          RELEASE_VERSION=$(echo $BRANCH_NAME | cut -d/ -f3)
          PR_TITLE=":package:release/$PACKAGE_NAME/$RELEASE_VERSION staging 배포"
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
          if [ ${{ github.actor }} = "leekh716" ]; then
            echo REVIEWER="rhiokim" >> $GITHUB_ENV
          else
            echo REVIEWER="leekh716" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        uses: devops-infra/action-pull-request@v0.5.5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_branch: "main"
          title: ${{ env.PR_TITLE }}
          assignee: ${{ github.actor }}
          reviewer: ${{ env.REVIEWER }}
          new_string: ${{ github.event.commits[0].message }}
          get_diff: false
